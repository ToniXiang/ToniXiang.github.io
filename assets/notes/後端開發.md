## API 設計原則

RESTful API 是現代 Web 開發的標準，遵循以下原則：

### HTTP 方法對應

```txt
GET     // 獲取資源
POST    // 創建資源
PUT     // 更新資源（整體更新）
PATCH   // 更新資源（部分更新）
DELETE  // 刪除資源
```

### 狀態碼設計

```txt
// 成功響應
200 OK          // 請求成功
201 Created     // 資源創建成功
204 No Content  // 成功但無返回內容

// 客戶端錯誤
400 Bad Request     // 請求格式錯誤
401 Unauthorized    // 未授權
404 Not Found       // 資源不存在
422 Unprocessable Entity  // 請求格式正確但語義錯誤

// 伺服器錯誤
500 Internal Server Error  // 伺服器內部錯誤
```

## Node.js + Express 實作

### 基本設置

```javascript
const express = require('express');
const app = express();

// 中間件
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// CORS 支援
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type,Authorization');
    next();
});
```

### 路由設計

```javascript
// 用戶相關路由
app.get('/api/users', getAllUsers);
app.get('/api/users/:id', getUserById);
app.post('/api/users', createUser);
app.put('/api/users/:id', updateUser);
app.delete('/api/users/:id', deleteUser);

// 控制器函數
async function getAllUsers(req, res) {
    try {
        const users = await User.find();
        res.json({
            success: true,
            data: users
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            message: error.message
        });
    }
}
```

### 錯誤處理

```javascript
// 全域錯誤處理中間件
app.use((error, req, res, next) => {
    console.error(error.stack);
    
    res.status(error.status || 500).json({
        success: false,
        message: error.message || '伺服器內部錯誤',
        ...(process.env.NODE_ENV === 'development' && { stack: error.stack })
    });
});
```

## 資料庫操作

### MongoDB + Mongoose

```javascript
const mongoose = require('mongoose');

// 用戶模型
const userSchema = new mongoose.Schema({
    name: { type: String, required: true },
    email: { type: String, required: true, unique: true },
    createdAt: { type: Date, default: Date.now }
});

const User = mongoose.model('User', userSchema);

// 資料庫連接
mongoose.connect('mongodb://localhost:27017/myapp', {
    useNewUrlParser: true,
    useUnifiedTopology: true
});
```

## 驗證與授權

### JWT Token

```javascript
const jwt = require('jsonwebtoken');

// 生成 Token
function generateToken(user) {
    return jwt.sign(
        { id: user._id, email: user.email },
        process.env.JWT_SECRET,
        { expiresIn: '24h' }
    );
}

// 驗證中間件
function authenticateToken(req, res, next) {
    const token = req.headers['authorization'];
    
    if (!token) {
        return res.status(401).json({ message: '缺少授權標頭' });
    }
    
    jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
        if (err) return res.status(403).json({ message: 'Token 無效' });
        req.user = user;
        next();
    });
}
```

## 最佳實踐

### 1. API 版本控制

```javascript
// URL 版本控制
app.use('/api/v1', v1Routes);
app.use('/api/v2', v2Routes);

// 標頭版本控制
app.use((req, res, next) => {
    const version = req.headers['api-version'] || 'v1';
    req.apiVersion = version;
    next();
});
```

### 2. 請求限制

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 分鐘
    max: 100, // 最多 100 次請求
    message: '請求過於頻繁，請稍後再試'
});

app.use('/api/', limiter);
```

### 3. 輸入驗證

```javascript
const { body, validationResult } = require('express-validator');

const validateUser = [
    body('name').notEmpty().withMessage('姓名不能為空'),
    body('email').isEmail().withMessage('電子郵件格式錯誤'),
    
    (req, res, next) => {
        const errors = validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(422).json({
                success: false,
                errors: errors.array()
            });
        }
        next();
    }
];

app.post('/api/users', validateUser, createUser);
```

## 文檔與測試
- 使用 **Swagger** 生成 API 文檔
- 撰寫 **單元測試** 和 **整合測試**
- 設置 **CI/CD** 自動化部署

---

*RESTful API 是後端開發的基礎，掌握好這些概念對於全端開發非常重要！*
